<!doctype html><!--
888b    888               888              d8b               8888888b.                    d8b                        8888888b.          888    888                                      
8888b   888               888              Y8P               888  "Y88b                   Y8P                        888   Y88b         888    888                                      
88888b  888               888                                888    888                                              888    888         888    888                                      
888Y88b 888  .d88b.   .d88888  .d88b.     8888 .d8888b       888    888  .d88b.  .d8888b  888  .d88b.  88888b.       888   d88P 8888b.  888888 888888 .d88b.  888d888 88888b.  .d8888b  
888 Y88b888 d88""88b d88" 888 d8P  Y8b    "888 88K           888    888 d8P  Y8b 88K      888 d88P"88b 888 "88b      8888888P"     "88b 888    888   d8P  Y8b 888P"   888 "88b 88K      
888  Y88888 888  888 888  888 88888888     888 "Y8888b.      888    888 88888888 "Y8888b. 888 888  888 888  888      888       .d888888 888    888   88888888 888     888  888 "Y8888b. 
888   Y8888 Y88..88P Y88b 888 Y8b.    d8b  888      X88      888  .d88P Y8b.          X88 888 Y88b 888 888  888      888       888  888 Y88b.  Y88b. Y8b.     888     888  888      X88 
888    Y888  "Y88P"   "Y88888  "Y8888 Y8P  888  88888P'      8888888P"   "Y8888   88888P' 888  "Y88888 888  888      888       "Y888888  "Y888  "Y888 "Y8888  888     888  888  88888P' 
                                           888                                                     888                                                                                  
                                          d88P                                                Y8b d88P                                                                                  
                                        888P"                                                  "Y88P"                                                                                   


> Hey, it seems you are a curious one and that you like to hack! :) 
> Maybe you should follow us on Twitter at @mariocasciaro & @loige

> Did you know that this website is open source?
> Check out https://github.com/nodejs-design-patterns-book/nodejsdesignpatterns.com

--><html lang="" class="has-navbar-fixed-top"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Node.js race conditions</title><meta property="og:title" content="Node.js race conditions"><meta name="description" content="Can there be race conditions with Node.js? Actually yes, let&#39;s see some examples and some solutions."><meta property="og:description" content="Can there be race conditions with Node.js? Actually yes, let&#39;s see some examples and some solutions."><meta property="og:url" content="https://www.nodejsdesignpatterns.com/blog/node-js-race-conditions/"><meta name="url" content="https://www.nodejsdesignpatterns.com/blog/node-js-race-conditions/"><meta name="pageKey" content="blogarticlesnode-js-race-conditionsindex"><meta property="og:image" content="https://www.nodejsdesignpatterns.com/blog/node-js-race-conditions/og_node-js-race-conditions.jpg"><meta property="og:image:width" content="1200"><meta property="og:image:height" content="669"><meta property="fb:app_id" content="765341910910483"><meta property="og:locale" content="en_US"><meta property="og:site_name" content="Node.js Design Patterns"><meta property="og:type" content="article"><meta name="twitter:card" content="summary_large_image"><meta name="robots" content="index, follow"><meta name="author" content="Luciano Mammino and Mario Casciaro, authors@nodejsdesignpatterns.com"><meta name="copyright" content="Mario Casciaro, Luciano Mammino, Packt Publishing"><meta name="generator" content="@11ty/eleventy v0.11.0"><meta http-equiv="last-modified" content="Sun, 24 Jan 2021 18:35:00 GMT"><meta name="date" content="Sun, 24 Jan 2021 18:35:00 GMT"><link rel="alternate" type="application/rss+xml" title="RSS Feed for www.nodejsdesignpatterns.com" href="/blog/rss.xml"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="manifest" href="/site.webmanifest"><meta name="theme-color" content="#FFFFFF"><style>@keyframes spinAround{0%{transform:rotate(0deg)}to{transform:rotate(359deg)}}@font-face{font-family:"Playfair Display";font-style:normal;font-weight:600;src:url(/assets//fonts/Playfair_Display_600.eot);src:local(""),url(/assets//fonts/Playfair_Display_600.eot?#iefix) format("embedded-opentype"),url(/assets//fonts/Playfair_Display_600.woff2) format("woff2"),url(/assets//fonts/Playfair_Display_600.woff) format("woff"),url(/assets//fonts/Playfair_Display_600.ttf) format("truetype"),url(/assets//fonts/Playfair_Display_600.svg#PlayfairDisplay) format("svg")}.button,.delete,.file{-webkit-touch-callout:none;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}.block:not(:last-child),.content:not(:last-child),.level:not(:last-child),.title:not(:last-child){margin-bottom:1.5rem}.delete{-moz-appearance:none;-webkit-appearance:none;background-color:rgba(50,50,50,.2);border:0;border-radius:290486px;cursor:pointer;pointer-events:auto;display:inline-block;flex-grow:0;flex-shrink:0;font-size:0;height:20px;max-height:20px;max-width:20px;min-height:20px;min-width:20px;outline:0;position:relative;vertical-align:top;width:20px}.delete::after,.delete::before{background-color:#fff;content:"";display:block;left:50%;position:absolute;top:50%;transform:translateX(-50%) translateY(-50%) rotate(45deg);transform-origin:center center}.delete::before{height:2px;width:50%}.delete::after{height:50%;width:2px}.delete:focus,.delete:hover{background-color:rgba(50,50,50,.3)}.delete:active{background-color:rgba(50,50,50,.4)}.is-medium.delete{height:24px;max-height:24px;max-width:24px;min-height:24px;min-width:24px;width:24px}.button{-moz-appearance:none;-webkit-appearance:none;align-items:center;border:3px solid transparent;border-radius:4px;box-shadow:none;display:inline-flex;font-size:1rem;height:2.5em;justify-content:flex-start;line-height:1.5;padding:calc(.5em - 3px) calc(.75em - 3px);position:relative;vertical-align:top}.button:active,.button:focus,.is-active.button{outline:0}
/*! minireset.css v0.0.6 | MIT License | github.com/jgthms/minireset.css */
@keyframes moveIndeterminate{0%{background-position:200% 0}to{background-position:-200% 0}}body,h1,h2,h3,h5,hr,html,li,ol,p,pre{margin:0;padding:0}h1,h2,h3,h5{font-size:100%;font-weight:400}button{margin:0}html{box-sizing:border-box;background-color:#fff;font-size:16px;-moz-osx-font-smoothing:grayscale;-webkit-font-smoothing:antialiased;min-width:300px;overflow-x:hidden;overflow-y:scroll;text-rendering:optimizeLegibility;text-size-adjust:100%;scroll-behavior:smooth}*,::after,::before{box-sizing:inherit}.card,img{max-width:100%}img{height:auto}article,aside,footer,section{display:block}body,button{font-family:"Open Sans",sans-serif}code,pre{-moz-osx-font-smoothing:auto;-webkit-font-smoothing:auto;font-family:monospace}body,code{font-weight:400}body{color:#999;font-size:1em;line-height:1.5}a{color:#da8f4c;cursor:pointer;text-decoration:none}a strong,pre code{color:currentColor}a:hover,strong{color:#363636}code{color:#da1039;font-size:.875em;padding:.25em .5em}code,hr,pre{background-color:#f5f5f5}hr{border:0;display:block;height:2px;margin:1.5rem 0}span{font-style:inherit;font-weight:inherit}strong{font-weight:700}pre{-webkit-overflow-scrolling:touch;color:#999;font-size:.875em;overflow-x:auto;padding:1.25rem 1.5rem;white-space:pre;word-wrap:normal}pre code{background-color:transparent;font-size:1em;padding:0}.card{background-color:#fff;border-radius:.25rem;box-shadow:0 .5em 1em -.125em rgba(50,50,50,.1),0 0 0 1px rgba(50,50,50,.02);color:#999;overflow:hidden;position:relative}.level{align-items:center;justify-content:space-between}.level code{border-radius:4px}.level img{display:inline-block;vertical-align:top}@media screen and (min-width:769px),print{.level{display:flex}}.menu{font-size:1rem}.menu.is-medium{font-size:1.25rem}.navbar{background-color:#fff;min-height:3.25rem;position:relative;z-index:30}.navbar-brand,.navbar>.container{align-items:stretch;display:flex;min-height:3.25rem}.navbar>.container{width:100%}.navbar.has-shadow{box-shadow:0 2px 0 0 #f5f5f5}.navbar.is-fixed-top{left:0;position:fixed;right:0;z-index:30;top:0}body.has-navbar-fixed-top,html.has-navbar-fixed-top{padding-top:3.25rem}.navbar-brand{flex-shrink:0}.navbar-brand a.navbar-item:focus,.navbar-brand a.navbar-item:hover{background-color:transparent}.navbar-burger{color:#999;cursor:pointer;display:block;height:3.25rem;position:relative;width:3.25rem;margin-left:auto}.navbar-burger span{background-color:currentColor;display:block;height:1px;left:calc(50% - 8px);position:absolute;transform-origin:center;transition-duration:86ms;transition-property:background-color,opacity,transform;transition-timing-function:ease-out;width:16px}.navbar-burger span:nth-child(1){top:calc(50% - 6px)}.navbar-burger span:nth-child(2){top:calc(50% - 1px)}.navbar-burger span:nth-child(3){top:calc(50% + 4px)}.navbar-burger:hover{background-color:rgba(0,0,0,.05)}.navbar-burger.is-active span:nth-child(1){transform:translateY(5px) rotate(45deg)}.navbar-burger.is-active span:nth-child(2){opacity:0}.navbar-burger.is-active span:nth-child(3){transform:translateY(-5px) rotate(-45deg)}.navbar-menu{display:none}.navbar-item{color:#999;display:block;line-height:1.5;padding:.5rem .75rem;position:relative;flex-grow:0;flex-shrink:0}.navbar-item .icon:only-child{margin-left:-.25rem;margin-right:-.25rem}a.navbar-item{cursor:pointer}a.navbar-item.is-active,a.navbar-item:focus,a.navbar-item:focus-within,a.navbar-item:hover{background-color:#fafafa;color:#da8f4c}.navbar-item img{max-height:1.75rem}@media screen and (max-width:1023px){.navbar>.container{display:block}.navbar-brand .navbar-item{align-items:center;display:flex}.navbar-menu{background-color:#fff;box-shadow:0 8px 16px rgba(50,50,50,.1);padding:.5rem 0}.navbar-menu.is-active{display:block}.navbar.is-fixed-top .navbar-menu{-webkit-overflow-scrolling:touch;max-height:calc(100vh - 3.25rem);overflow:auto}}@media screen and (min-width:1024px){.navbar,.navbar-end,.navbar-menu{align-items:stretch;display:flex}.navbar{min-height:3.25rem}.navbar-burger{display:none}.navbar-item{align-items:center;display:flex}.navbar-menu{flex-grow:1;flex-shrink:0}.navbar-end{justify-content:flex-end;margin-left:auto}.container>.navbar .navbar-brand,.navbar>.container .navbar-brand{margin-left:-.75rem}.container>.navbar .navbar-menu,.navbar>.container .navbar-menu{margin-right:-.75rem}a.navbar-item.is-active{color:#323232}a.navbar-item.is-active:not(:focus):not(:hover){background-color:transparent}}.button{background-color:#fff;border-color:#dbdbdb;border-width:3px;color:#363636;cursor:pointer;justify-content:center;padding-bottom:calc(.5em - 3px);padding-left:1em;padding-right:1em;padding-top:calc(.5em - 3px);text-align:center;white-space:nowrap}.button strong{color:inherit}.button .icon,.button .icon.is-medium{height:1.5em;width:1.5em}.button .icon:first-child:not(:last-child){margin-left:calc(-.5em - 3px);margin-right:.25em}.button .icon:last-child:not(:first-child){margin-left:.25em;margin-right:calc(-.5em - 3px)}.button .icon:first-child:last-child{margin-left:calc(-.5em - 3px);margin-right:calc(-.5em - 3px)}.button:hover{border-color:#da8f4c;color:#363636}.button:focus{border-color:#754418;color:#363636}.button:focus:not(:active){box-shadow:0 0 0 .125em rgba(218,143,76,.25)}.button.is-active,.button:active{border-color:#da8f4c;color:#363636}.button.is-medium{font-size:1.25rem}.container{flex-grow:1;margin:0 auto;position:relative;width:auto}@media screen and (min-width:1024px){.container{max-width:960px}}@media screen and (min-width:1216px){.container:not(.is-max-desktop){max-width:1152px}}.content li+li{margin-top:.25em}.content ol:not(:last-child),.content p:not(:last-child),.content pre:not(:last-child){margin-bottom:1em}.content h1,.content h2,.content h3,.content h5{color:#363636;font-weight:600;line-height:1.125}.content h1{font-size:2em;margin-bottom:.5em}.content h1:not(:first-child){margin-top:1em}.content h2{font-size:1.75em;margin-bottom:.5714em}.content h2:not(:first-child){margin-top:1.1428em}.content h3{font-size:1.5em;margin-bottom:.6666em}.content h3:not(:first-child){margin-top:1.3333em}.content h5{font-size:1.125em;margin-bottom:.8888em}.content ol{list-style-position:outside;margin-left:2em;margin-top:1em}.content ol:not([type]){list-style-type:decimal}.content pre{-webkit-overflow-scrolling:touch;overflow-x:auto;padding:1.25em 1.5em;white-space:pre;word-wrap:normal}.content.is-medium{font-size:1.25rem}.icon{align-items:center;display:inline-flex;justify-content:center;height:1.5rem;width:1.5rem}.icon.is-medium{height:2rem;width:2rem}.image{display:block;position:relative}.image img{display:block;height:auto;width:100%}.tag:not(body){align-items:center;background-color:#f5f5f5;border-radius:4px;color:#999;display:inline-flex;font-size:.75rem;height:2em;justify-content:center;line-height:1.5;padding-left:.75em;padding-right:.75em;white-space:nowrap}.tag:not(body) .delete{margin-left:.25rem;margin-right:-.375rem}.tag:not(body).is-medium{font-size:1rem}.tag:not(body) .icon:first-child:not(:last-child){margin-left:-.375em;margin-right:.1875em}.tag:not(body) .icon:last-child:not(:first-child){margin-left:.1875em;margin-right:-.375em}.tag:not(body) .icon:first-child:last-child{margin-left:-.375em;margin-right:-.375em}a.tag:hover{text-decoration:underline}.title{word-break:break-word;color:#363636;font-size:2rem;font-weight:600;line-height:1.125}.title em,.title span,.title strong{font-weight:inherit}.title .tag{vertical-align:middle}.title strong{color:inherit}.title.is-2{font-size:2.5rem}.title.is-4{font-size:1.5rem}.file.is-medium,.number,.title.is-5{font-size:1.25rem}.number{align-items:center;background-color:#f5f5f5;border-radius:290486px;display:inline-flex;height:2em;justify-content:center;margin-right:1.5rem;min-width:2.5em;padding:.25rem .5rem;text-align:center;vertical-align:top}.file{align-items:stretch;display:flex;justify-content:flex-start;position:relative}.help{display:block;font-size:.75rem;margin-top:.25rem}.column{display:block;flex-basis:0;flex-grow:1;flex-shrink:1;padding:.75rem}@media screen and (min-width:769px),print{.column.is-three-quarters{flex:none;width:75%}.column.is-one-quarter{flex:none;width:25%}.column.is-2{flex:none;width:16.6666666667%}.column.is-4{flex:none;width:33.3333333333%}.column.is-5{flex:none;width:41.6666666667%}.column.is-8{flex:none;width:66.6666666667%}}.columns{margin-left:-.75rem;margin-right:-.75rem;margin-top:-.75rem}.columns:last-child{margin-bottom:-.75rem}.columns:not(:last-child){margin-bottom:calc(1.5rem - .75rem)}@media screen and (min-width:769px),print{.columns:not(.is-desktop){display:flex}}.columns.is-variable{--columnGap: 0.75rem;margin-left:calc(-1*var(--columnGap));margin-right:calc(-1*var(--columnGap))}.columns.is-variable .column{padding-left:var(--columnGap);padding-right:var(--columnGap)}.columns.is-variable.is-2{--columnGap: 0.5rem}.columns.is-variable.is-4{--columnGap: 1rem}.columns.is-variable.is-5{--columnGap: 1.25rem}.columns.is-variable.is-8{--columnGap: 2rem}.mt-1{margin-top:.25rem!important}.mt-2{margin-top:.5rem!important}.is-size-7{font-size:.75rem!important}@media screen and (max-width:768px){.is-hidden-mobile{display:none!important}}.hero{align-items:stretch;display:flex;flex-direction:column;justify-content:space-between}#faq button,.hero .navbar{background:0 0}@media screen and (min-width:769px),print{.hero.is-medium .hero-body{padding:9rem 1.5rem}}.hero-body{flex-grow:1;flex-shrink:0}.hero-body,.section{padding:3rem 1.5rem}@media screen and (min-width:1024px){.section.is-medium{padding:9rem 1.5rem}}.footer{background-color:#fafafa;padding:3rem 1.5rem 6rem}code .number{align-items:normal;background-color:transparent;border-radius:0;display:inline;height:auto;justify-content:normal;margin-right:auto;min-width:auto;padding:0;text-align:left;vertical-align:baseline;font-size:inherit}@media (prefers-reduced-motion:reduce){html{scroll-behavior:auto}}.title{font-family:"Playfair Display",serif}.container{color:#4c4c4c}div,h1,h2,h3,p{line-height:1.5rem}nav a.navbar-item{color:#656565;font-weight:700}.bg-green{background-color:#b9eec5}.bg-white{background-color:#fff}nav.navbar{z-index:99999!important}#hero h1{line-height:4.5rem;font-size:3.5rem}#hero h2{line-height:3rem;font-size:1.8rem}#authors h3.title,#reviews h2{margin:0 0 3rem;padding:0;line-height:3rem}#reviews .column{padding:1.5rem 1rem}#book-content h2,#book-content h3{margin:0;padding:0;line-height:3rem}#book-content h3{padding:3rem 0 0}#book-content .columns{margin:0}#authors .column,#book-content .columns .column{padding-top:0;padding-bottom:0}#authors h2,#sample-chapter h2,#sample-chapter h3{line-height:3rem;margin:0}#sample-chapter p{margin-top:1.5rem}#authors section{padding-bottom:24rem}#authors h2{padding:0}#authors h3.title{margin:3rem 0 1.5rem;text-align:center}#authors p{line-height:1.5rem}#faq button{border:0;text-align:left;width:100%;cursor:pointer;position:relative}#faq button:active{border:0}#faq button:focus{border:0;outline:0}#faq button h3{font-size:1rem;line-height:1.5rem;margin:1.5rem 0 0;text-align:left;font-weight:700;padding-left:3em}#faq button[aria-expanded=false] h3::before,#faq button[aria-expanded=true] h3::before{content:"+ ";font-weight:700;color:#3ed05f;display:inline-block;position:absolute;left:0}#faq button[aria-expanded=true] h3::before{content:"- "}.bd-lt{border-radius:6rem 0 0 0}.bd-rd{border-radius:0 0 6rem 0}.article article h2,.article article h3{margin-top:1.25em}.article article h2 code,.article article h3 code{font-size:inherit;padding:inherit;background:0 0;color:inherit}.article article p{margin-top:.75em}.article article p:first-child{margin-top:0;font-size:1.25em;line-height:1.5em}.article article .author-info{padding:0 0 1em;margin:0 0 1em;border-bottom:1px solid #eee}.article article .author-info p{color:#616161;display:flex;align-items:center;font-size:1em}.article article .author-info a{display:flex;align-items:center;margin:0 .75em 0 0}.article article .author-info img{width:2em;border-radius:50%;margin:0 .75em}.article article .author-info svg{margin:0 .75em 0 0}.article aside .wrapper-sticky{position:-webkit-sticky;position:sticky;top:80px}.article aside .aside-ad-block .book{transform:translateX(-1em)}.article aside .aside-ad-block a{background:#b9eec5;padding:1em;border-radius:1em;margin:0 0 2em;color:#323232;display:block;border:3px solid transparent}.article aside .aside-ad-block a:hover{border:3px solid #2bb049}.article aside .aside-ad-block h5{font-weight:700;font-size:.8em;padding:0 0 .2em}.article aside .aside-ad-block p{font-size:.8em}.article aside h3{margin-bottom:1em}.article aside .toc{margin:0 0 2em}.article aside .toc ol{padding:0 0 0 2em;list-style:decimal-leading-zero}.blog .resources{display:flex;justify-content:space-around;flex-wrap:wrap;margin:3em 0}.blog .resources .resource{width:33%;min-width:300px;margin:0 0 2em}.blog .resources .resource a{display:block;border-radius:6px;padding:1em 0}.blog .resources .resource a:hover{color:#323232;background-color:#ebc4a1}.blog .resources .resource p{padding:1em;text-align:center;color:#323232}</style><script async src="https://www.googletagmanager.com/gtag/js?id=UA-42283801-2"></script><script>window.dataLayer = window.dataLayer || [];
        function gtag() {
          dataLayer.push(arguments);
        }
        gtag('js', new Date());
        gtag('config', 'UA-42283801-2');</script><style type="text/css">code[class*="language-"],
        pre[class*="language-"] {
          color: #ccc;
          background: none;
          font-family: Consolas, Monaco, 'Andale Mono', 'Ubuntu Mono', monospace;
          font-size: 1em;
          text-align: left;
          white-space: pre;
          word-spacing: normal;
          word-break: normal;
          word-wrap: normal;
          line-height: 1.5;

          -moz-tab-size: 4;
          -o-tab-size: 4;
          tab-size: 4;

          -webkit-hyphens: none;
          -moz-hyphens: none;
          -ms-hyphens: none;
          hyphens: none;

        }

        /* Code blocks */
        pre[class*="language-"] {
          padding: 1em;
          margin: 0.5em 0;
          overflow: auto;
        }

        :not(pre) > code[class*="language-"],
        pre[class*="language-"] {
          background: #2d2d2d;
        }

        /* Inline code */
        :not(pre) > code[class*="language-"] {
          padding: 0.1em;
          border-radius: 0.3em;
          white-space: normal;
        }

        .token.block-comment,
        .token.cdata,
        .token.comment,
        .token.doctype,
        .token.prolog {
          color: #999;
        }

        .token.punctuation {
          color: #ccc;
        }

        .token.attr-name,
        .token.deleted,
        .token.namespace,
        .token.tag {
          color: #e2777a;
        }

        .token.function-name {
          color: #6196cc;
        }

        .token.boolean,
        .token.function,
        .token.number {
          color: #f08d49;
        }

        .token.class-name,
        .token.constant,
        .token.property,
        .token.symbol {
          color: #f8c555;
        }

        .token.atrule,
        .token.builtin,
        .token.important,
        .token.keyword,
        .token.selector {
          color: #cc99cd;
        }

        .token.attr-value,
        .token.char,
        .token.regex,
        .token.string,
        .token.variable {
          color: #7ec699;
        }

        .token.entity,
        .token.operator,
        .token.url {
          color: #67cdcc;
        }

        .token.bold,
        .token.important {
          font-weight: bold;
        }
        .token.italic {
          font-style: italic;
        }

        .token.entity {
          cursor: help;
        }

        .token.inserted {
          color: green;
        }</style></head><body><nav class="navbar is-fixed-top has-shadow" role="navigation" aria-label="main navigation"><div class="container"><div class="navbar-brand"><div class="navbar-item"><a href="/"><h1 class="title is-5">Node.js Design Patterns</h1></a></div><a role="button" class="navbar-burger burger" aria-label="menu" aria-expanded="false" data-target="navbar"><span aria-hidden="true"></span> <span aria-hidden="true"></span> <span aria-hidden="true"></span></a></div><div id="navbar" class="navbar-menu"><div class="navbar-end"><a href="/#reviews" class="navbar-item" onclick="gtag('event', 'click', { 'event_category': 'navigation', 'event_label': 'click_nav_reviews', 'value': 1 });">Reviews</a> <a href="/#book-content" class="navbar-item" onclick="gtag('event', 'click', { 'event_category': 'navigation', 'event_label': 'click_nav_book_content', 'value': 1 });">Content</a> <a href="/#sample-chapter" class="navbar-item" onclick="gtag('event', 'click', { 'event_category': 'navigation', 'event_label': 'click_nav_sample_chapter', 'value': 1 });">Sample chapter</a> <a href="/#authors" class="navbar-item" onclick="gtag('event', 'click', { 'event_category': 'navigation', 'event_label': 'click_nav_authors', 'value': 1 });">Authors</a> <a href="/#faq" class="navbar-item" onclick="gtag('event', 'click', { 'event_category': 'navigation', 'event_label': 'click_nav_faq', 'value': 1 });">FAQs</a> <a href="/blog" class="navbar-item">Blog</a></div></div></div></nav><section class="hero is-medium bg-green bd-rd"><div class="hero-body"><div class="container"><h1 class="title">Node.js race conditions</h1></div></div></section><div class="bg-green article"><section class="section bd-lt bg-white is-medium"><div class="container"><div class="columns is-variable is-8"><article class="column is-three-quarters"><div class="author-info"><p><span class="written-by-icon is-hidden-mobile"><svg xmlns="http://www.w3.org/2000/svg" aria-label="Written by" role="img" viewBox="0 0 24 24" width="1em" height="1em"><path fill="currentColor" d="M19 20H5a1 1 0 0 0 0 2h14a1 1 0 0 0 0-2z"/><path fill="currentColor" d="M5 18h.09l4.17-.38a2 2 0 0 0 1.21-.57l9-9a1.92 1.92 0 0 0-.07-2.71L16.66 2.6A2 2 0 0 0 14 2.53l-9 9a2 2 0 0 0-.57 1.21L4 16.91a1 1 0 0 0 .29.8A1 1 0 0 0 5 18zM15.27 4L18 6.73l-2 1.95L13.32 6z"/></svg> </span><span class="is-hidden-mobile">Published by </span><a href="https://loige.co"><img alt="Luciano Mammino's profile picture" src="/static/luciano-mammino-avatar-small.jpg"> Luciano Mammino </a><span class="is-hidden-mobile">on</span> &nbsp;Sun, 24 Jan 2021 18:35:00 GMT</p></div><main class="content"><p>A single-threaded event loop like the one used by JavaScript and Node.js, makes it somewhat harder to have race conditions, but, SPOILER ALERT: race conditions are still possible!</p><p>In this article, we will explore the topic of race conditions in Node.js. We will discuss some examples and present a few different solutions that can help us to make our code <em>race condition free</em>.</p><h2 id="what-is-a-race-condition%3F" class="title is-2">What is a race condition?</h2><p>First of all, let's try to clarify what a <em>race condition</em> actually is.</p><p>A race condition is a type of <em>programming error</em> that can occur when multiple processes or threads are accessing the same shared resource, for instance, a file on a file system or a record in a database, and at least one of them is trying to modify the resource.</p><p>Let's try to present an example. Imagine that while a thread is trying to rename a file, another thread is trying to delete the same file. In this case, the second thread will receive an error because, when it's trying to delete the file, the file has already been renamed. Or, the other way around, while one thread is trying to rename the file, the file was already deleted by the other thread and it's not available on the filesystem anymore.</p><p>In other cases, race conditions can be more subtle, because they wouldn't result in the program crashing, but they might just be the source of an incorrect or inconsistent behaviour. In these cases, since there is no explicit error and no stack trace, the issue is generally much harder to troubleshoot and fix.</p><p>A classic example is when 2 threads are trying to update the same data source and the new information is the result of a function applied to the current value.</p><p>Let's pretend we are building a Roman Empire simulation game in which we can manage some cash flow and we have a global balance in <a href="https://en.wiktionary.org/wiki/aureus"><em>aureus</em></a> (a currency used in the Roman Empire around 100 B.C.E.). Now, let's say that our initial balance is <code>0</code> <em>aurei</em> and that there are two independent game components (possibly running on separate threads) that are trying to increase the balance by <code>50</code> <em>aurei</em> each, we should expect that in the end, the balance is <code>100</code> <em>aurei</em>, right?</p><pre class="language-text"><code class="language-text">0 + 50 + 50 = 100 ðŸ¤‘</code></pre><p>If we implement this in a naive way, we might have the two components performing three distinct operations each:</p><ol><li>Read the current value for <code>balance</code></li><li>Add <code>50</code> <em>aurei</em> to it</li><li>Save the resulting value into <code>balance</code></li></ol><p>Since the two components are running in parallel, without any synchronisation mechanism, the following case could happen:</p><span style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 848px;"><picture><source type="image/png" srcset="/img/aurei-race-condition-node-js-8e3027ab-64.png 64w, /img/aurei-race-condition-node-js-8e3027ab-128.png 128w, /img/aurei-race-condition-node-js-8e3027ab-256.png 256w, /img/aurei-race-condition-node-js-8e3027ab-512.png 512w, /img/aurei-race-condition-node-js-8e3027ab-2002.png 2002w" sizes="(max-width: 848px) 100vw, 848px"><source type="image/webp" srcset="/img/aurei-race-condition-node-js-8e3027ab-64.webp 64w, /img/aurei-race-condition-node-js-8e3027ab-128.webp 128w, /img/aurei-race-condition-node-js-8e3027ab-256.webp 256w, /img/aurei-race-condition-node-js-8e3027ab-512.webp 512w, /img/aurei-race-condition-node-js-8e3027ab-2002.webp 2002w" sizes="(max-width: 848px) 100vw, 848px"><img loading="lazy" decoding="async" style="max-width: 100%; width: 100%; margin: 0px; vertical-align: middle;" alt="A race condition example showing 2 processes trying to update a balance" src="/img/aurei-race-condition-node-js-8e3027ab-64.png" width="64" height="30"></picture></span><p>In the picture above you can see that <strong>Component 2</strong> ends up having a <em>stale</em> view of the balance: the balance gets changed by <strong>Component 1</strong> after <strong>Component 2</strong> has read the balance. For this reason, when <strong>Component 2</strong> performs its own update, it is effectively overriding any change previously made by <strong>Component 1</strong>. This is why we have a race condition: the two components are effectively racing to complete their own tasks and they might end up stepping onto each other's toes! This doesn't make <em>Julius</em> happy I am afraid...</p><p>One way to solve this problem is to isolate the 2 concurrent operations into <em>transactions</em> and make sure that there is only one transaction running at a given time. This idea might look like this:</p><span style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 848px;"><picture><source type="image/png" srcset="/img/aurei-fixed-race-condition-node-js-a2696610-64.png 64w, /img/aurei-fixed-race-condition-node-js-a2696610-128.png 128w, /img/aurei-fixed-race-condition-node-js-a2696610-256.png 256w, /img/aurei-fixed-race-condition-node-js-a2696610-512.png 512w, /img/aurei-fixed-race-condition-node-js-a2696610-2022.png 2022w" sizes="(max-width: 848px) 100vw, 848px"><source type="image/webp" srcset="/img/aurei-fixed-race-condition-node-js-a2696610-64.webp 64w, /img/aurei-fixed-race-condition-node-js-a2696610-128.webp 128w, /img/aurei-fixed-race-condition-node-js-a2696610-256.webp 256w, /img/aurei-fixed-race-condition-node-js-a2696610-512.webp 512w, /img/aurei-fixed-race-condition-node-js-a2696610-2022.webp 2022w" sizes="(max-width: 848px) 100vw, 848px"><img loading="lazy" decoding="async" style="max-width: 100%; width: 100%; margin: 0px; vertical-align: middle;" alt="Fixing a race condition using a transaction" src="/img/aurei-fixed-race-condition-node-js-a2696610-64.png" width="64" height="31"></picture></span><p>In the last picture, we are using transactions to make sure that all the steps of <strong>Component 1</strong> happen in order before all the steps of <strong>Component 2</strong>. This prevents any <em>stale read</em> and makes sure that every component always has an up to date view of the world before doing any change. You can stop holding your breath now, Julius!</p><p>In the rest of this article, we will zoom in more on race conditions in the context of Node.js and we will see some other approaches to deal with them.</p><h2 id="can-we-have-race-conditions-in-node.js%3F" class="title is-2">Can we have race conditions in Node.js?</h2><p>It is a common misconception to think that Node.js does not have race conditions because of its single-threaded nature. While it is true that in Node.js you would not have multiple threads competing for resources, you might still end up with tasks belonging to different logical transactions being executed in an order that might result in <em>stale reads</em> and generate a race condition.</p><p>In the example that we illustrated above, we intentionally represented the various tasks (<em>read</em>, <em>increase</em> and <em>save</em>) as discrete units. Note how the system is never executing more than one task at the same time. This is a simple but accurate representation of how the Node.js event loop processes tasks on a single thread. Nonetheless, you can see that there might be situations where multiple logical transactions (e.g. multiple deposits) are scheduled concurrently on the event loop and the discrete tasks might end up being intermingled, which results in a race condition.</p><p>So... <strong>Yes</strong>, we can have race conditions in Node.js!</p><h2 id="a-node.js-example-with-a-race-condition" class="title is-2">A Node.js example with a race condition</h2><p>Now, let's talk some code! Let's try to re-create the Roman Empire simulation game example that we discussed above.</p><p>In ancient Rome, Romans used to export olives and grapes. No wonder Italy is still famous worldwide for olive oil and wine! In our game, we want to be able to harvest olives and grapes and then sell them as a means to acquire more <em>aurei</em>.</p><p>We are going to have two functions that can increase the balance by <code>50</code> <em>aurei</em> which we are going to call <code>sellOlives()</code> and <code>sellGrapes()</code>. We will also assume that every time the balance is changed, it is persisted to a data storage of sort (e.g. a database). For the sake of this example, we won't be using a real data storage, but we will just simulate some random asynchronous delay before reading or modifying a global value. This will be enough to illustrate how we can end up with a race condition.</p><p>For starts, let's see what a buggy implementation might look like:</p><pre class="language-javascript"><code class="language-javascript"><span class="token comment">// Utility function to simulate some delay (e.g. reading from or writing to a database).</span><br><span class="token comment">// It will take from 0 to 50ms in a random fashion.</span><br><span class="token keyword">const</span> <span class="token function-variable function">randomDelay</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token parameter">resolve</span> <span class="token operator">=></span><br>  <span class="token function">setTimeout</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">100</span><span class="token punctuation">)</span><br><span class="token punctuation">)</span><br><br><span class="token comment">// Our global balance.</span><br><span class="token comment">// In a more complete implementation, this will live in the persistent data storage.</span><br><span class="token keyword">let</span> balance <span class="token operator">=</span> <span class="token number">0</span><br><br><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">loadBalance</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  <span class="token comment">// simulates random delay to retrieve data from data storage</span><br>  <span class="token keyword">await</span> <span class="token function">randomDelay</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br>  <span class="token keyword">return</span> balance<br><span class="token punctuation">}</span><br><br><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">saveBalance</span> <span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  <span class="token comment">// simulates random delay to write the data to the data storage</span><br>  <span class="token keyword">await</span> <span class="token function">randomDelay</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br>  balance <span class="token operator">=</span> value<br><span class="token punctuation">}</span><br><br><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">sellGrapes</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  <span class="token keyword">const</span> balance <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">loadBalance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">sellGrapes - balance loaded: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>balance<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><br>  <span class="token keyword">const</span> newBalance <span class="token operator">=</span> balance <span class="token operator">+</span> <span class="token number">50</span><br>  <span class="token keyword">await</span> <span class="token function">saveBalance</span><span class="token punctuation">(</span>newBalance<span class="token punctuation">)</span><br>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">sellGrapes - balance updated: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>newBalance<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><br><span class="token punctuation">}</span><br><br><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">sellOlives</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  <span class="token keyword">const</span> balance <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">loadBalance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">sellOlives - balance loaded: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>balance<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><br>  <span class="token keyword">const</span> newBalance <span class="token operator">=</span> balance <span class="token operator">+</span> <span class="token number">50</span><br>  <span class="token keyword">await</span> <span class="token function">saveBalance</span><span class="token punctuation">(</span>newBalance<span class="token punctuation">)</span><br>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">sellOlives - balance updated: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>newBalance<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><br><span class="token punctuation">}</span><br><br><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">main</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  <span class="token keyword">const</span> transaction1 <span class="token operator">=</span> <span class="token function">sellGrapes</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// NOTE: no `await`</span><br>  <span class="token keyword">const</span> transaction2 <span class="token operator">=</span> <span class="token function">sellOlives</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// NOTE: no `await`</span><br>  <span class="token keyword">await</span> transaction1 <span class="token comment">// NOTE: awaiting here does not stop `transaction2` </span><br>                     <span class="token comment">// from being scheduled before transaction 1 is completed</span><br>  <span class="token keyword">await</span> transaction2<br>  <span class="token keyword">const</span> balance <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">loadBalance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Final balance: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>balance<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><br><span class="token punctuation">}</span><br><br><span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre><p>If we execute this code we might end up with different results. In one case we might get the correct outcome:</p><pre class="language-text"><code class="language-text">sellOlives - balance loaded: 0<br>sellOlives - balance updated: 50<br>sellGrapes - balance loaded: 50<br>sellGrapes - balance updated: 100<br>Final balance: 100</code></pre><p>But in other cases we might end up in a bad state:</p><pre class="language-text"><code class="language-text">sellGrapes - balance loaded: 0<br>sellOlives - balance loaded: 0<br>sellGrapes - balance updated: 50<br>sellOlives - balance updated: 50<br>Final balance: 50</code></pre><p>Note how in this last case, <code>sellOlives</code> is essentially a stale read and therefore it will end up overriding the balance disregarding any work already done by <code>sellGrapes</code>. Yes, we do have a race condition, unfortunately!</p><p>Now, this example is simple ad it is not too hard to pinpoint exactly where the race condition has originated by just looking at the code.</p><p>Take a minute or two to read the code again. Check out the output from the 2 cases as well. Pay attention to the notes and the log messages and try to imagine how the Node.js runtime might execute this code in the 2 different scenarios.</p><p>Ok, now that you have done that, let's discuss together what happens.</p><p>In our <code>main</code> function, when we execute <code>sellGrapes()</code> and <code>sellOlives()</code>, since we are not awaiting the two operations independently, we are essentially scheduling both operations onto the event loop.</p><p>We only await the two transactions after they have been already scheduled, which means that they will work concurrently. After the two transactions have been scheduled, we wait for <code>transaction1</code> to complete and only then we wait for <code>transaction2</code> to complete. Note that <code>transaction2</code> might complete even before <code>transaction1</code>. In other words, awaiting for <code>transaction1</code> doesn't block <code>transaction2</code> in any way.</p><p>This approach is similar to writing the following code:</p><pre class="language-javascript"><code class="language-javascript"><span class="token keyword">await</span> Promise<span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token function">sellGrapes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">sellOlives</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span></code></pre><p>Using <code>Promise.all()</code> is a more commonly used way to schedule different tasks to run concurrently.</p><p>Note that with <code>Promise.all()</code>, the resulting promise will reject as soon as any of the promises rejects. In our previous example, since we await the two promises independently, we will always catch errors in <code>transaction1</code> before <code>transaction2</code>.</p><p>But let's not digress too much into this. Now that we understand the problem, how do we fix the race condition?</p><p>Well, it turns out that in this simple case, we might make things right quite easily:</p><pre class="language-javascript"><code class="language-javascript"><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">main</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  <span class="token keyword">await</span> <span class="token function">sellGrapes</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// &lt;- schedule the first transaction and wait for completion</span><br>  <span class="token keyword">await</span> <span class="token function">sellOlives</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// &lt;- when it's completed, we start the second transaction </span><br>                     <span class="token comment">//    and wait for completion</span><br>  <span class="token keyword">const</span> balance <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">loadBalance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Final balance: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>balance<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><br><span class="token punctuation">}</span></code></pre><p>This implementation will consistently produce the following output:</p><pre class="language-text"><code class="language-text">sellGrapes - balance loaded: 0<br>sellGrapes - balance updated: 50<br>sellOlives - balance loaded: 50<br>sellOlives - balance updated: 100<br>Final balance: 100</code></pre><p>As we can observe, <code>sellGrapes</code> is always started and completed <em>before</em> we start <code>sellOlives</code>. This makes the two logical transactions isolated and makes sure their tasks won't end up being mixed together in random order.</p><p>Problem solved... <em>vade in pacem</em> dear race condition!</p><h2 id="using-a-mutex-in-node.js" class="title is-2">Using a mutex in Node.js</h2><p>OK, the previous example was illustrative, but if we are building a real game, chances are things will end up being a lot more complicated. We will probably end up having many different actions that might cause a change of balance. Those actions might be the result of a particular sequence of events and it might become hard to track down the discrete logical transactions that we have to <em>serialize</em> in order to avoid race conditions.</p><p>Ideally, we don't want to think in terms of transactions, we just need to make sure that we never read the balance if there is another concurrent operation that is ready to change its value.</p><p>To be able to do this we need two things:</p><ol><li>Have a way to identify when <em>we are about to change</em> the balance</li><li>Let other events wait in line until the change is completed before reading the balance</li></ol><p>We could say that when <em>we are about to change</em> the balance we enter a <em>critical path</em> and that we don't want to intermingle events from different logical transactions in a critical path.</p><p>One way to achieve this is by using a <em>Mutex</em> (which stands for <a href="https://en.wikipedia.org/wiki/Mutual_exclusion"><strong>mut</strong>ual <strong>ex</strong>clusion</a>).</p><p>A mutex is a mechanism that allows synchronising access to a shared resource.</p><p>We can see a mutex as a shared object that allows us to mark when the code execution is entering and exiting from a critical path. In addition to that, a mutex can help us to queue other logical transactions that want to access the same critical path while one transaction is being processed.</p><p>Before talking code, be aware that using a mutex might have a performance impact in your application and that this solution won't work if you use a distributed or a multi-process setup. More details on this later.</p><h2 id="using-async-mutex" class="title is-2">Using <code>async-mutex</code></h2><p>A very useful library that we can useg is <a href="https://npm.im/async-mutex"><code>async-mutex</code></a>. This library provides a promise-based implementation of the mutex pattern.</p><p>You can install this library from <code>npm</code>:</p><pre class="language-bash"><code class="language-bash"><span class="token function">npm</span> <span class="token function">install</span> --save async-mutex</code></pre><p>Now, here's an example of how we could use this library to mark the beginning and the end of a critical path:</p><pre class="language-javascript"><code class="language-javascript"><span class="token keyword">import</span> <span class="token punctuation">{</span> Mutex <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'async-mutex'</span><br><br><span class="token keyword">const</span> mutex <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Mutex</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// creates a shared mutex instance</span><br><br><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">doingSomethingCritical</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  <span class="token keyword">const</span> release <span class="token operator">=</span> <span class="token keyword">await</span> mutex<span class="token punctuation">.</span><span class="token function">acquire</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// acquires access to the critical path</span><br>  <span class="token keyword">try</span> <span class="token punctuation">{</span><br>    <span class="token comment">// ... do stuff on the critical path</span><br>  <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span><br>    <span class="token function">release</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// completes the work on the critical path</span><br>  <span class="token punctuation">}</span><br><span class="token punctuation">}</span></code></pre><p>In this example, we are using a global mutex instance to mark the beginning and the end of a critical path which happens inside our <code>doingSomethingCritical()</code> function.</p><p>When we call <code>mutex.acquire()</code>, this method will return a promise. If no other concurrent operation is currently on the same critical path, the promise resolves to a function that we call <code>release</code>. In this situation, we are essentially granted exclusive access to the critical path. If some concurrent operation is on the critical path already, the promise won't resolve until the concurrent operation already on the critical path has completed. This is how concurrent operations <em>wait in line</em> for our exclusive access to the critical path.</p><p>The <code>release</code> function must be invoked to mark the completion of the work on the critical path. It effectively <em>releases</em> the exclusive access to the critical path and makes it available to the next task in line. Note that we are using a <code>try</code>/<code>finally</code> block here to make sure that <code>release</code> is called even in case of an exception. It is very important to do so. In fact, failing to call <code>release</code>, will leave all the other events waiting in line forever!</p><p>Now let's try to use <code>async-mutex</code> to avoid race conditions in our game:</p><pre class="language-javascript"><code class="language-javascript"><span class="token keyword">import</span> <span class="token punctuation">{</span> Mutex <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'async-mutex'</span><br><br><span class="token keyword">const</span> <span class="token function-variable function">randomDelay</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><span class="token comment">/* ... */</span><span class="token punctuation">}</span><br><br><span class="token keyword">let</span> balance <span class="token operator">=</span> <span class="token number">0</span><br><span class="token keyword">const</span> mutex <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Mutex</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// global mutex instance</span><br><br><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">loadBalance</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">/* ... */</span><span class="token punctuation">}</span><br><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">saveBalance</span> <span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">/* ... */</span><span class="token punctuation">}</span><br><br><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">sellGrapes</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  <span class="token comment">// this code will need exclusive access to the balance</span><br>  <span class="token comment">// so we consider this to be a critical path</span><br>  <span class="token keyword">const</span> release <span class="token operator">=</span> <span class="token keyword">await</span> mutex<span class="token punctuation">.</span><span class="token function">acquire</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// get access to the critical path (or wait in line)</span><br>  <span class="token keyword">try</span> <span class="token punctuation">{</span><br>    <span class="token keyword">const</span> balance <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">loadBalance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">sellGrapes - balance loaded: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>balance<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><br>    <span class="token keyword">const</span> newBalance <span class="token operator">=</span> balance <span class="token operator">+</span> <span class="token number">50</span><br>    <span class="token keyword">await</span> <span class="token function">saveBalance</span><span class="token punctuation">(</span>newBalance<span class="token punctuation">)</span><br>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">sellGrapes - balance updated: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>newBalance<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><br>  <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span><br>    <span class="token function">release</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// completes work on the critical path</span><br>  <span class="token punctuation">}</span><br><span class="token punctuation">}</span><br><br><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">sellOlives</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  <span class="token comment">// similar to `sellGrapes` this is a critical path because</span><br>  <span class="token comment">// it needs exclusive access to balance</span><br>  <span class="token keyword">const</span> release <span class="token operator">=</span> <span class="token keyword">await</span> mutex<span class="token punctuation">.</span><span class="token function">acquire</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br>  <span class="token keyword">try</span> <span class="token punctuation">{</span><br>    <span class="token keyword">const</span> balance <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">loadBalance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">sellOlives - balance loaded: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>balance<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><br>    <span class="token keyword">const</span> newBalance <span class="token operator">=</span> balance <span class="token operator">+</span> <span class="token number">50</span><br>    <span class="token keyword">await</span> <span class="token function">saveBalance</span><span class="token punctuation">(</span>newBalance<span class="token punctuation">)</span><br>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">sellOlives - balance updated: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>newBalance<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><br>  <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span><br>    <span class="token function">release</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br>  <span class="token punctuation">}</span><br><span class="token punctuation">}</span><br><br><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">main</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  <span class="token comment">// Here we can call many events safely, the mutex will guarantee that the</span><br>  <span class="token comment">// competing events are executed in the right order!</span><br>  <span class="token keyword">await</span> Promise<span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span><span class="token punctuation">[</span><br>    <span class="token function">sellGrapes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><br>    <span class="token function">sellOlives</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><br>    <span class="token function">sellGrapes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><br>    <span class="token function">sellOlives</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><br>    <span class="token function">sellGrapes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><br>    <span class="token function">sellOlives</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br>  <span class="token punctuation">]</span><span class="token punctuation">)</span><br>  <span class="token keyword">const</span> balance <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">loadBalance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Final balance: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>balance<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><br><span class="token punctuation">}</span><br><br><span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre><p>The code above will consistently produce the following output:</p><pre class="language-text"><code class="language-text">sellGrapes - balance loaded: 0<br>sellGrapes - balance updated: 50<br>sellOlives - balance loaded: 50<br>sellOlives - balance updated: 100<br>sellGrapes - balance loaded: 100<br>sellGrapes - balance updated: 150<br>sellOlives - balance loaded: 150<br>sellOlives - balance updated: 200<br>sellGrapes - balance loaded: 200<br>sellGrapes - balance updated: 250<br>sellOlives - balance loaded: 250<br>sellOlives - balance updated: 300<br>Final balance: 300</code></pre><p>Some of the code has been truncated for simplicity. You can find all the examples in <a href="https://github.com/lmammino/node-js-race-conditions">this repository</a>.</p><p>From the example above, you can see how mutexes can provide a convenient way of thinking about exclusive access and how they can help to avoid race conditions. We are intentionally triggering multiple calls to <code>sellGrapes()</code> and <code>sellOlives()</code> concurrently, to make obvious that we don't have to think about potential race conditions at the <em>calling point</em>. This means that, as our game grows more complicated, we can keep invoking these functions without having to worry about generating new race conditions.</p><h2 id="let's-implement-a-mutex" class="title is-2">Let's implement a mutex</h2><p>But what if we are dealing with a race condition only in one place in our entire application? Is it worth to include and manage an external dependecy just because of that? Can we come up with a simpler alternative that does not require us to install a new dependency?</p><p>It turns out that we can easily do that! Let's see how we can implement our own mutex.</p><p>Note that the solution we are going to present here is effectively a variation of the <strong>sequential execution pattern</strong> using promises that is presented in <em>Chapter 5</em> of <a href="/">Node.js Design Patterns</a>.</p><p>The idea is to inizialize our global mutex as an instance of a resolved promise:</p><pre class="language-javascript"><code class="language-javascript"><span class="token keyword">let</span> mutex <span class="token operator">=</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre><p>Then in our critical path we can do something like this:</p><pre class="language-javascript"><code class="language-javascript"><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">doingSomethingCritical</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  mutex <span class="token operator">=</span> mutex<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>    <span class="token comment">// ... do stuff on the critical path</span><br>  <span class="token punctuation">}</span><span class="token punctuation">)</span><br>  <span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>    <span class="token comment">// ... manage errors on the critical path</span><br>  <span class="token punctuation">}</span><span class="token punctuation">)</span><br>  <span class="token keyword">return</span> mutex<br><span class="token punctuation">}</span></code></pre><p>The idea is that every time we are invoking the function <code>doingSomethingCritical()</code> we are effectively &quot;queueing&quot; the execution of the code on the critical path using <code>mutex.then()</code>. If this is the first call, our initial instance of the <code>mutex</code> promise is a resolved promise, so the code on the critical path will be executed straight away on the next cycle of the event loop.</p><p>Calling <code>.then()</code> on a promise returns a new promise instance that is used to replace the original <code>mutex</code> instance and it's also returned by the <code>doingSomethingCritical()</code> function.</p><p>This allows us to have concurrent calls to <code>doingSomethingCritical()</code> being queued to be executed sequentially.</p><p>Note that we also specify a <code>mutex.catch()</code>. This allows us to catch and react to specific errors, but it also allows us not to break the chain of sequential execution in case an operation fails.</p><p>Ok, now that we have explored this idea, let's apply it to our example.</p><p>This is how our code is going to look like:</p><pre class="language-javascript"><code class="language-javascript"><span class="token keyword">const</span> <span class="token function-variable function">randomDelay</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><span class="token comment">/* ... */</span><span class="token punctuation">}</span><br><br><span class="token keyword">let</span> balance <span class="token operator">=</span> <span class="token number">0</span><br><span class="token keyword">let</span> mutex <span class="token operator">=</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// global mutex instance</span><br><br><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">loadBalance</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">/* ... */</span><span class="token punctuation">}</span><br><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">saveBalance</span> <span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">/* ... */</span><span class="token punctuation">}</span><br><br><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">sellGrapes</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  mutex <span class="token operator">=</span> mutex<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>    <span class="token keyword">const</span> balance <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">loadBalance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">sellGrapes - balance loaded: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>balance<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><br>    <span class="token keyword">const</span> newBalance <span class="token operator">=</span> balance <span class="token operator">+</span> <span class="token number">50</span><br>    <span class="token keyword">await</span> <span class="token function">saveBalance</span><span class="token punctuation">(</span>newBalance<span class="token punctuation">)</span><br>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">sellGrapes - balance updated: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>newBalance<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><br>  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><br>  <span class="token keyword">return</span> mutex<br><span class="token punctuation">}</span><br><br><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">sellOlives</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  mutex <span class="token operator">=</span> mutex<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>    <span class="token keyword">const</span> balance <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">loadBalance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">sellOlives - balance loaded: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>balance<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><br>    <span class="token keyword">const</span> newBalance <span class="token operator">=</span> balance <span class="token operator">+</span> <span class="token number">50</span><br>    <span class="token keyword">await</span> <span class="token function">saveBalance</span><span class="token punctuation">(</span>newBalance<span class="token punctuation">)</span><br>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">sellOlives - balance updated: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>newBalance<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><br>  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><br>  <span class="token keyword">return</span> mutex<br><span class="token punctuation">}</span><br><br><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">main</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  <span class="token keyword">await</span> Promise<span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span><span class="token punctuation">[</span><br>    <span class="token function">sellGrapes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><br>    <span class="token function">sellOlives</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><br>    <span class="token function">sellGrapes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><br>    <span class="token function">sellOlives</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><br>    <span class="token function">sellGrapes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><br>    <span class="token function">sellOlives</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br>  <span class="token punctuation">]</span><span class="token punctuation">)</span><br>  <span class="token keyword">const</span> balance <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">loadBalance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Final balance: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>balance<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><br><span class="token punctuation">}</span><br><br><span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre><p>If you try to run this code, you will see that it consistently prints the same output as per our previous implementation using <code>async-mutex</code>!</p><p>So, here we have it, a simple mutex implementation in just few lines of code leveraging promise chainability!</p><h2 id="mutex-with-multiple-processes" class="title is-2">Mutex with multiple processes</h2><p>It is important to mention that the solutions presented in this article only work in a Node.js application running on a single process.</p><p>If you are running your application on multiple processes (for instance, by using the <a href="https://nodejs.org/api/cluster.html"><code>cluster</code> module</a>, <a href="https://nodejs.org/api/worker_threads.html">worker threads</a> or a multi-process runner like <a href="https://pm2.keymetrics.io/"><code>pm2</code></a>) using a mutex within our code is not going to solve race conditions across processes. This is also the case if you are running your application on multiple servers.</p><p>In these cases you have to rely on more complicated solutions like <a href="https://martin.kleppmann.com/2016/02/08/how-to-do-distributed-locking.html">distributed locks</a> or, if you are using a central database, you can rely on solutions provided by your own database systems. We will discuss a simple example in the next section.</p><h2 id="mutex-performance" class="title is-2">Mutex performance</h2><p>We already mentioned that using a mutex might have a relevant performance impact in your application.</p><p>To try to visualize why a mutex has a performance impact in your application let's try to think about the case when an operation is trying to acquire a lock on a mutex but the mutex is already locked. In this case, our operation is simply waiting without doing nothing, while for instance it could be doing some IO operation like connecting to the database or sending a query. It will probably take the event loop several spins before the lock is released and the operation that is waiting in line can acquire the lock. This get worse with a high number of operations waiting in line.</p><p>With a mutex we are effectively serializing tasks, making sure that executed in sequence and non-concurrently. If you abuse this pattern, you might end up in a situation where you could effectively eliminate all concurrency from your application.</p><p>Measuring how a mutex might impact your specific application is not something that can be done holistically and we recommend you to run your own benchmarks to find out what is the effect of introducing one or more mutex instances in your application.</p><p>Our general recommendation is to use a mutex only when you are sure you have to protect your code from a race condition and to try to make the critical path as short as possible.</p><p>Be aware that a mutex is not the only solution to race conditions. For instance, in our example, if we were to use a real relational database as a data storage, we could have avoided any race condition (at the application level) by letting the database itself do the increment using a SQL query:</p><pre class="language-sql"><code class="language-sql"><span class="token keyword">UPDATE</span> game <span class="token keyword">SET</span> aurei <span class="token operator">=</span> aurei <span class="token operator">+</span> <span class="token number">50</span><span class="token punctuation">;</span></code></pre><p>With this approach, we are trusting the database to do the right thing and we are not slowing down our application.</p><p>And there are other alternative approches. Just to name one, <a href="https://en.wikipedia.org/wiki/Optimistic_concurrency_control">optimistic locks</a> might provide a great alternative if race conditions are possible but they actually happen only in rare occasions.</p><h2 id="conclusion" class="title is-2">Conclusion</h2><p>In this article, we have explored race conditions and learned why they can be harmful. We showed how race conditions can happen in Node.js and several techniques to address them including the adoptopm of a mutex.</p><p>This is an interesting topic which often gets explored in the context of multi-threaded languages. The theory isn't much different but there are some important differences when dealing with concurrent, single-threaded languages like Node.js.</p><p>If you are curious to understand better the difference between <strong>Parallelism</strong> and <strong>Concurrency</strong> I strongly recommend you to read this great essay titled <a href="http://yosefk.com/blog/parallelism-and-concurrency-need-different-tools.html">parallelism and concurrency need different tools</a>. You can also watch this wonderful talk by <a href="https://twitter.com/steveklabnik">Steve Klabnik</a> called <a href="https://www.youtube.com/watch?v=lJ3NC-R3gSI">Rust's Journey to Async/Await</a> (yes, it's not only about Rust, trust me).</p><p>I really hope you enjoyed this article. Make sure to <a href="https://twitter.com/loige">reach out to me on Twitter</a> and let me know what you think!</p><p>Bye ðŸ˜‹</p><h2 id="credits" class="title is-2">Credits</h2><p>Thanks to <a href="https://github.com/Jack-Barry">Jack Barry</a> for the inspiration for this post on the <a href="https://github.com/PacktPublishing/Node.js-Design-Patterns-Third-Edition/discussions/25">Node.js Design Patterns discussion board</a>. Thanks to <a href="https://twitter.com/quasi_modal">Peter Caulfield</a>, <a href="https://twitter.com/StefanoAbalsamo">Stefano Abalsamo</a>, <a href="https://twitter.com/gbinside">Roberto Gambuzzi</a> and <a href="https://twitter.com/mariocasciaro">Mario Casciaro</a> for kindly reviewing this post.</p></main></article><aside class="column is-one-quarter"><div class="wrapper-sticky"><div class="aside-ad-block"><a href="/" onclick="gtag('event', 'click', { 'event_category': 'blog', 'event_label': 'click_blog_sidebar_ad', 'value': 1 });"><span style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 380px;"><picture><source type="image/png" srcset="/img/book-stack-c1898e47-64.png 64w, /img/book-stack-c1898e47-128.png 128w, /img/book-stack-c1898e47-256.png 256w, /img/book-stack-c1898e47-1338.png 1338w" sizes="(max-width: 380px) 100vw, 380px"><source type="image/webp" srcset="/img/book-stack-c1898e47-64.webp 64w, /img/book-stack-c1898e47-128.webp 128w, /img/book-stack-c1898e47-256.webp 256w, /img/book-stack-c1898e47-1338.webp 1338w" sizes="(max-width: 380px) 100vw, 380px"><img loading="lazy" decoding="async" style="max-width: 100%; width: 100%; margin: 0px; vertical-align: middle;" class="book" alt="Node.js Design Patterns book cover" src="/img/book-stack-c1898e47-64.png" width="64" height="51"></picture></span><h5>Take your Node.js knowledge to the next level.</h5><p>Get <em>Node.js Design Patterns</em> today to learn how to design and implement production-grade Node.js applications using proven patterns and techniques.</p></a></div><h3 class="title is-4">Sections</h3><div class="toc"><ol><li><a href="#what-is-a-race-condition%3F">What is a race condition?</a></li><li><a href="#can-we-have-race-conditions-in-node.js%3F">Can we have race conditions in Node.js?</a></li><li><a href="#a-node.js-example-with-a-race-condition">A Node.js example with a race condition</a></li><li><a href="#using-a-mutex-in-node.js">Using a mutex in Node.js</a></li><li><a href="#using-async-mutex">Using async-mutex</a></li><li><a href="#let's-implement-a-mutex">Let's implement a mutex</a></li><li><a href="#mutex-with-multiple-processes">Mutex with multiple processes</a></li><li><a href="#mutex-performance">Mutex performance</a></li><li><a href="#conclusion">Conclusion</a></li><li><a href="#credits">Credits</a></li></ol></div><h3 class="title is-4">Share</h3><a title="Share this article on Twitter" class="share-btn twitter" href="https://twitter.com/share?url=https%3A%2F%2Fwww.nodejsdesignpatterns.com%2Fblog%2Fnode-js-race-conditions%2F&text=Node.js%20race%20conditions&hashtags=nodejs" target="_blank"><svg xmlns="http://www.w3.org/2000/svg" aria-label="Twitter" role="img" viewBox="0 0 512 512" width="32px" height="32px"><rect width="512" height="512" rx="15%" fill="#1da1f2"/><path fill="#fff" d="M437 152a72 72 0 0 1-40 12 72 72 0 0 0 32-40 72 72 0 0 1-45 17 72 72 0 0 0-122 65 200 200 0 0 1-145-74 72 72 0 0 0 22 94 72 72 0 0 1-32-7 72 72 0 0 0 56 69 72 72 0 0 1-32 1 72 72 0 0 0 67 50 200 200 0 0 1-105 29 200 200 0 0 0 309-179 200 200 0 0 0 35-37"/></svg> </a><a title="Share this article on Facebook" class="share-btn facebook" href="https://www.facebook.com/sharer.php?u=https%3A%2F%2Fwww.nodejsdesignpatterns.com%2Fblog%2Fnode-js-race-conditions%2F" target="_blank"><svg xmlns="http://www.w3.org/2000/svg" aria-label="Facebook" role="img" viewBox="0 0 512 512" width="32px" height="32px"><rect width="512" height="512" rx="15%" fill="#1877f2"/><path d="M355.6 330l11.4-74h-71v-48c0-20.2 9.9-40 41.7-40H370v-63s-29.3-5-57.3-5c-58.5 0-96.7 35.4-96.7 99.6V256h-65v74h65v182h80V330h59.6z" fill="#fff"/></svg> </a><a title="Share this article on LinkedIn" class="share-btn linkedin" href="https://www.linkedin.com/shareArticle?url=https%3A%2F%2Fwww.nodejsdesignpatterns.com%2Fblog%2Fnode-js-race-conditions%2F&title=Node.js%20race%20conditions" target="_blank"><svg xmlns="http://www.w3.org/2000/svg" aria-label="LinkedIn" role="img" viewBox="0 0 512 512" fill="#fff" width="32px" height="32px"><rect width="512" height="512" rx="15%" fill="#0077b5"/><circle cx="142" cy="138" r="37"/><path stroke="#fff" stroke-width="66" d="M244 194v198M142 194v198"/><path d="M276 282c0-20 13-40 36-40 24 0 33 18 33 45v105h66V279c0-61-32-89-76-89-34 0-51 19-59 32"/></svg> </a><a title="Share this article on Pinterest" class="share-btn pinterest" href="https://pinterest.com/pin/create/bookmarklet/?url=https%3A%2F%2Fwww.nodejsdesignpatterns.com%2Fblog%2Fnode-js-race-conditions%2F&description=Node.js%20race%20conditions" target="_blank"><svg xmlns="http://www.w3.org/2000/svg" aria-label="Pinterest" role="img" viewBox="0 0 512 512" width="32px" height="32px"><rect width="512" height="512" rx="15%" fill="#bd081b"/><path d="m265 65c-104 0-157 75-157 138 0 37 14 71 45 83 5 2 10 0 12-5l3-18c2-6 1-7-2-12-9-11-15-24-15-43 0-56 41-106 108-106 60 0 92 37 92 85 0 64-28 116-70 116-23 0-40-18-34-42 6-27 19-57 19-77 0-18-9-34-30-34-24 0-42 25-42 58 0 20 7 34 7 34l-29 120a249 249 0 0 0 2 86l3-1c2-3 31-37 40-72l16-61c7 15 29 28 53 28 71 0 119-64 119-151 0-66-56-126-140-126z" fill="#fff"/></svg> </a><a title="Share this article by email" class="share-btn email" href="mailto:?&body=Check%20out%20%22Node.js%20race%20conditions%22(https%3A%2F%2Fwww.nodejsdesignpatterns.com%2Fblog%2Fnode-js-race-conditions%2F)&subject=Node.js%20race%20conditions" target="_blank"><svg xmlns="http://www.w3.org/2000/svg" aria-label="Email" role="img" viewBox="0 0 512 512" width="32px" height="32px"><rect width="512" height="512" rx="15%" fill="teal"/><rect width="356" height="256" x="78" y="128" fill="#fff" rx="8%"/><path fill="none" stroke="teal" stroke-width="20" d="M434 128L269 292c-7 8-19 8-26 0L78 128m0 256l129-128m227 128L305 256"/></svg></a></div></aside></div></div></section></div><footer class="footer"><div class="container"><p class="is-size-7">Copyright Â© 2014-2021 Mario Casciaro, Luciano Mammino, Packt Publishing.</p><p class="is-size-7">All trademarks and registered trademarks are the property of their respective owners.</p><p class="is-size-7 mt-1">Icons <strong>Unicons</strong> by <a href="https://iconscout.com" rel="nofollow noreferer">Iconscout</a></p><hr><p class="mt-2">Found an error or something that can be improved? You can help us make this website better on <a href="https://github.com/nodejs-design-patterns-book/nodejsdesignpatterns.com">GitHub</a>!</p></div></footer><script type="text/javascript" defer="defer" src="/assets/main.b808a2739f6ecdb2163b.js" integrity="sha256-o3LP5967X02mZTPF6wukEp2sa1+DapL+/F/JHBzkW5c="></script></body></html>